<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Untappd API</title>

    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">




    <script src="https://www.gstatic.com/firebasejs/4.10.0/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyAl6h2TDLbhuqPvCcRenX7KVgvtPtJVUDE",
            authDomain: "bringmybeerbro-a2b2e.firebaseapp.com",
            databaseURL: "https://bringmybeerbro-a2b2e.firebaseio.com",
            projectId: "bringmybeerbro-a2b2e",
            storageBucket: "bringmybeerbro-a2b2e.appspot.com",
            messagingSenderId: "787446559372"
        };
        firebase.initializeApp(config);
    </script>

    <script>
        //      https://github.com/larsha/bolaget.io
        //      BreweryDB - API-key: 7c3c827d07c560a0ff836f3b889f32e8

        window.addEventListener("load", function() {
            // Initialize Firebase
            const db = firebase.database();
            
            // Autentisering börjar här
            // AuthSpinner object  
            let authSpinner = {
                ifUser : false,
                myStorage: window.localStorage,
                key: "userStatus",
                activated: "1",
                unactivated: "0",
                activateSpinner: function() {
                    for (var i = 0; i < this.myStorage.length; i++) {
                        let localKey = this.myStorage.key(i);
                        let localVal = this.myStorage.getItem(this.myStorage.key(i));
                        if (localKey === this.key && localVal === this.activated) {
                            this.myStorage.setItem(this.key, this.unactivated);
                            this.spinner(this.ifUser);
                        }
                    }
                },
                spinner: function(aUser) {
                    let container = document.getElementsByClassName("loaderContainer")[0];
                    let lSpinner = document.getElementsByClassName("loader")[0];
                    let body = document.getElementsByTagName("body")[0];
                    container.appendChild(lSpinner);
                    body.appendChild(container);
                    
                    if (aUser === false) {
                        container.style.display = "block";
                        lSpinner.style.display = "block";
                    }
                    else{
                        lSpinner.style.display = "none";
                        container.style.display = "none";
                    }
                }
            };
            authSpinner.activateSpinner(); // Kör igång spinner funktionen
            
            // Providers
            let facebookProvider = new firebase.auth.FacebookAuthProvider();
            let googleProvider = new firebase.auth.GoogleAuthProvider();
            let logInWithFb = document.getElementById("facebookBtn");
            let logInWithgoogle = document.getElementById("googleBtn");
            // Signar in med Google
            logInWithgoogle.addEventListener("click", function(event) {
                firebase.auth().signInWithRedirect(googleProvider);
                authSpinner.myStorage.setItem(authSpinner.key, authSpinner.activated);
            });
            // Signar in med FB
            logInWithFb.addEventListener("click", function(event) {
                firebase.auth().signInWithRedirect(facebookProvider);
                authSpinner.myStorage.setItem(authSpinner.key, authSpinner.activated);
            });
            let user = {};
            let userList = [];

            function getUsers() {
                db.ref("users/").once("value", function(snapshot) {
                    let data = snapshot.val();
                    let keys = Object.keys(data);
                    let keyNr = 0;
                    for (let user in data) {
                        let userInfo = data[user];
                        let key = keys[keyNr];
                        keyNr++;
                        user = {
                            dbId: key,
                            name: userInfo.name,
                            favorites: userInfo.favorites,
                            email: userInfo.email,
                            img: userInfo.profileImg,
                            uId: userInfo.id
                        }
                        userList.push(user);
                    }
                    console.log(userList);
                    getUserInfo(userList);
                })
            }; // getUsers ends here
            getUsers(); // Activate function
            
            function getUserInfo(uList) {
                firebase.auth().onAuthStateChanged(function(user) {
                    let elements = {
                        logged: document.getElementsByClassName("logged")[0],
                        notLogged: document.getElementsByClassName("notLogged")[0],
                        header: document.getElementsByTagName("header")[0],
                        userDiv: document.createElement("div"),
                        logOutBtn: document.createElement("button"),
                        imgcontainer: document.createElement("div"),
                        img: document.createElement("img"),
                        name: document.createElement("span"),
                    };
                    if (user) {
                        // User is signed in.
                        authSpinner.ifUser = true;
                        authSpinner.spinner(authSpinner.ifUser);
                        
                        var displayName = user.displayName;
                        var email = user.email;
                        var emailVerified = user.emailVerified;
                        var photoURL = user.photoURL;
                        var isAnonymous = user.isAnonymous;
                        var uid = user.uid;
                        var providerData = user.providerData;
                        
                        let uData = {
                            name: displayName,
                            email: email,
                            profileImg: photoURL,
                            id: uid
                        };
                        
                        console.log('onAuthStateChanged: user is signed in', user);
                        console.log("User logged in..");
                        elements.userDiv.setAttribute("class", "userDiv");
                        elements.logOutBtn.setAttribute("id", "logOut");
                        elements.logOutBtn.innerText = "Sign out";
                        elements.name.innerText = `${displayName}`;
                        elements.imgcontainer.setAttribute("class", "userInfo");
                        elements.img.setAttribute("class", "userImg");
                        elements.img.setAttribute("src", photoURL);
                        elements.imgcontainer.appendChild(elements.img);
                        elements.userDiv.appendChild(elements.logOutBtn);
                        elements.userDiv.appendChild(elements.name);
                        elements.userDiv.appendChild(elements.imgcontainer);
                        elements.header.appendChild(elements.userDiv);
                        elements.logged.style.display = "block";
                        elements.notLogged.style.display = "none";
                        // Log-out function
                        let loggedOut = document.getElementById('logOut');
                        let logOut = function(event) {
                            firebase.auth().signOut().then(function(result) {
                                    console.log('User signed out');
                                    elements.logged.style.display = "none";
                                    elements.notLogged.style.display = "block";
                                    elements.userDiv.style.display = "none";
                                    authSpinner.myStorage.setItem(authSpinner.key, 0);
                                })
                                .catch(function(error) {
                                    console.log('Signout failed');
                                })
                        };
                        loggedOut.addEventListener('click', logOut); // Logoutlistener
                        function checkUsers(list) {
                            let userExist = true; // Variabel som kollar om ett id som är identiskt som användaren
                            for (i = 0; i < userList.length; i++) { // Går igenom listan  
                                if (userList[i].uId === uData.id) { // Kollar om ett användar redan id redan finns
                                    console.log("Match = " + userList[i].uId);
                                    userExist = true;
                                    break; // Isf bryt loopen
                                } else { // Annars ingen match, och userExist är false
                                    console.log("No Match");
                                    userExist = false;
                                }
                            }
                            if (userExist === false)
                                db.ref("users/").push(uData);

                        }; // End of checkUsers
                        checkUsers(uList);
                    } else {
                        console.log("No User");
                    }
                })
            }; // getUserInfo ends

            firebase.auth().getRedirectResult().then(function(result) {
                if (result.credential) { // authSpinner gives you a Facebook Access Token. You can use it to access the Facebook API.  
                    var token = result.credential.accessToken;
                }
                var user = result.user; // The signed-in user info.
            }).catch(function(error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
                var email = error.email;
                var credential = error.credential; // The firebase.auth.AuthCredential type that was used.
            })
            // Autentisering slutar här
            
            let clientId = "153D83356A0B65CE0BDB2F2058AA09CEE92F165D";
            let clientSecret = "7B480C43412EF225E1E7E6F802A05FEE835B016B";
            let searchBeerBtn = document.getElementById("searchBeerBtn");
            let searchBeerInput = document.getElementById("searchBeerInput");
            let container = document.getElementsByClassName("container")[0];
            let beerArray = [];

            function printOut(array) {

                container.innerHTML = "";
                let increment = 0;

                for (let i = 0; i < array.length; i++) {
                    //                        console.log(db[i].id)
                    let content = {
                        div: document.createElement("div"),

                        hide: document.createElement("a"),
                        show: document.createElement("a"),
                        moreInfo: document.createElement("div"),
                        arrowUp: document.createElement("div"),
                        arrowDown: document.createElement("div"),

                        img: document.createElement("img"),
                        beerNameShow: document.createElement("h2"),
                        beerNameHide: document.createElement("h2"),
                        style: document.createElement("h4"),
                        brewery: document.createElement("h5"),
                        description: document.createElement("p"),
                        favorite: document.createElement("button"),
                    }

                    content.div.setAttribute("class", "card-body beer");


                    content.hide.setAttribute("id", "hide" + increment);
                    content.hide.setAttribute("href", "#hide" + increment);
                    content.hide.setAttribute("class", "hide");
                    content.arrowUp.setAttribute("class", "arrowUp");


                    content.show.setAttribute("id", "show" + increment);
                    content.show.setAttribute("href", "#show" + increment);
                    content.show.setAttribute("class", "show");
                    content.arrowDown.setAttribute("class", "arrowDown");

                    content.moreInfo.setAttribute("class", "details");

                    content.img.setAttribute("src", array[i].beer.beer_label);
                    content.img.setAttribute("height", "140px");

                    content.favorite.setAttribute("class", "btn btn-outline-light");
                    content.favorite.setAttribute("id", array[i].beer.bid);

                    content.favorite.innerText = "Favorite";
                    content.beerNameShow.innerText = array[i].beer.beer_name;
                    content.beerNameHide.innerText = array[i].beer.beer_name;
                    content.style.innerText = array[i].beer.beer_style;
                    content.brewery.innerText = array[i].brewery.brewery_name;
                    content.description.innerText = array[i].beer.beer_description;

                    content.hide.appendChild(content.arrowDown);
                    content.hide.appendChild(content.beerNameHide);
                    content.div.appendChild(content.hide);

                    content.show.appendChild(content.arrowUp);
                    content.show.appendChild(content.beerNameShow);
                    content.div.appendChild(content.show);


                    content.moreInfo.appendChild(content.img);
                    content.moreInfo.appendChild(content.style);
                    content.moreInfo.appendChild(content.brewery);
                    content.moreInfo.appendChild(content.description);
                    content.moreInfo.appendChild(content.favorite);

                    content.div.appendChild(content.moreInfo);
                    container.appendChild(content.div);

                    increment++;
                }
            }

            searchBeerBtn.addEventListener("click", function() {
                beerArray = [];
                let value = searchBeerInput.value;
                fetch(`https://api.untappd.com/v4/search/beer?q=${value}&client_id=${clientId}&client_secret=${clientSecret}`)
                    .then(function(request) {
                        return request.json();
                    })
                    .then(function(json) {
                        let beerDB = json;
                        for (let i = 0; i < beerDB.response.beers.items.length; i++) {
                            beerArray.push(beerDB.response.beers.items[i]);
                        }
                        //                    console.log(beerArray[0].brewery.brewery_name)
                        //                    console.log(beerArray[0].brewery.country) //ska detta användas?
                        //                    console.log(beerArray[0].beer.bid) //id på öl
                        //                    console.log(beerArray[0].beer.beer_description) //beskrivning, olika bra beroende på popularitet
                        //                    console.log(beerArray[0].beer.beer_label) //bild 
                        //                    console.log(beerArray[0].beer.beer_style) // typ av öl 
                        //                    console.log(beerArray[0].beer.beer_name) //namnet på ölen
                        printOut(beerArray);
                    })
                    .catch(function(error) {
                        console.log(error);
                    })
            })


            container.addEventListener("click", function(e) {
                let toNumber = parseInt(e.target.id);
                //                console.log(beerArray)
                let beerObj = {}
                for (let i = 0; i < beerArray.length; i++) {
                    if (toNumber == beerArray[i].beer.bid) {
                        console.log("match! just like tinder")
                        beerObj.name = beerArray[i].beer.beer_name;
                        beerObj.style = beerArray[i].beer.beer_style;
                        beerObj.description = beerArray[i].beer.beer_description;
                        beerObj.brewery = beerArray[i].brewery.brewery_name;
                        beerObj.img = beerArray[i].beer.beer_label;
                        db.ref("users/carl/favorites/").push(beerObj);

                    }
                }
            })
        })
    </script>
</head>

<body>
    <header>
        <nav class="navbar navbar-light bg-faded">
            <a class="navbar-brand" href="untappd.html">

                <img src='./beerLogo7.png' alt='logo' height="60" width="60" class="logotype"> 
                <h3>Bring My Beer Bro</h3>
            </a>
            <!--<div id='profilePic'></div>  SLäckte ner denna och implementerar min kod // Jonte-->
        </nav>
    </header>
    <main>
        <div class="logged">
            <div class="searchField">
                <div class="searchbar">
                    <input id="searchBeerInput" type="search" placeholder="Search for a beer">
                    <button id="searchBeerBtn" class="btn btn-outline-warning">Search beer!</button>
                </div>
            </div>
            <div class="searchTitle">
                <h1>Beers to bring</h1>
            </div>
            <div class="container card">
            </div>
        </div>
        <div class="loaderContainer">
            <div class="loader"></div>
        </div>


        <div class="notLogged">
            <div class="logContainer">
                <div class="logInSection">
                    <button id="googleBtn">Log in with Google</button>
                    <button id="facebookBtn"> Log in with FB</button>
                </div>
            </div>
        </div>
    </main>

</body>

</html>